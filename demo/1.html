<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #replay {
        width: 100%;
        height: 100%;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div id="operations">
      <button onclick="startRecord()">开始录制</button>
      <button onclick="stopRecord()">停止录制</button>
      <button onclick="toggleDom()" class="btn">测试按钮</button>
      <button onclick="replay()">回放</button>
    </div>
    <!-- 添加一些测试用的交互元素 -->
    <div id="app">
      <h1>RRWeb 测试</h1>
      <input type="text" placeholder="请输入文字" />
      <p class="rrweb-block">
        Lorem ipsum dolor sit amet consectetur adipisicing elit. Id cumque
        repudiandae ad accusamus atque ipsum eaque tempora autem, magnam odit
        laboriosam magni, temporibus voluptatem minima, natus possimus est
        aperiam dolorum?
      </p>
      <div id="container"></div>
    </div>
    <!-- 回放时使用的容器 -->
    <div id="replay"></div>
  </body>
  <script>
    let events = []; // 用于存储录制的事件
    let stopFn = null;
    let rrwebLoaded = false;
    let replayLoaded = false;

    // 加载录制相关资源
    async function loadRRWeb() {
      if (rrwebLoaded) return;

      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = '../packages/rrweb/dist/rrweb.umd.cjs';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });

      rrwebLoaded = true;
    }

    // 加载回放相关资源
    async function loadReplay() {
      if (replayLoaded) return;

      // 动态加载 CSS
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '../packages/rrweb-player/dist/style.css';
      document.head.appendChild(link);

      // 动态加载 JS
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = '../packages/rrweb-player/dist/rrweb-player.umd.cjs';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });

      replayLoaded = true;
    }

    // 开始录制
    async function startRecord() {
      await loadRRWeb(); // 加载录制资源

      events = [];
      stopFn = rrweb.record({
        emit(event) {
          events.push(event);
        },
        blockClass: 'rrweb-block',
      });
      console.log('开始录制');
    }

    // 停止录制
    function stopRecord() {
      if (stopFn) {
        stopFn();
        console.log('停止录制，共记录 ' + events.length + ' 个事件');
      }
    }

    // 回放录制的内容
    async function replay() {
      if (events.length === 0) {
        alert('没有可回放的内容');
        return;
      }

      await loadReplay(); // 加载回放资源
      const replayer = new rrwebPlayer.Player({
        target: document.querySelector('#replay'),
        props: {
          events,
          speed: 1,
          showController: true,
        },
      });
      replayer.play();
    }

    let isShow = false;
    const container = document.querySelector('#container');
    // 动态创建一个div元素
    const div = document.createElement('div');
    div.textContent = '这是一个动态节点';
    div.style.padding = '20px';
    div.style.background = '#f0f0f0';
    div.style.margin = '10px';

    function toggleDom() {
      // 切换显示/隐藏
      isShow = !isShow;
      if (isShow) {
        container.appendChild(div);
      } else {
        if (container.contains(div)) {
          container.removeChild(div);
        }
      }
    }
  </script>
</html>
